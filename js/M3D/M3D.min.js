
if(!window.M3D){window.M3D={};window.M3D.Model=new Function();window.M3D.Model.Instance=new Function();window.M3D.Model.Material=new Function();}
(function(){var elementID=0;var M3Dp={};var vecIn=new Float32Array(3);var vecAt=new Float32Array(3);var vecUp=new Float32Array(3);var vecX=new Float32Array(3);var vecY=new Float32Array(3);var vecZ=new Float32Array(3);var identityMatrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function normalizedVec3(vec,dst){dst||(dst=vec);var length=Math.sqrt(vec[0]*vec[0]+vec[1]*vec[1]+vec[2]*vec[2]);if(length!==0){dst[0]=vec[0]/length;dst[1]=vec[1]/length;dst[2]=vec[2]/length;}
return dst;}
function crossNormalizedVec3(vec1,vec2,dst){dst[0]=vec1[1]*vec2[2]-vec1[2]*vec2[1];dst[1]=vec1[2]*vec2[0]-vec1[0]*vec2[2];dst[2]=vec1[0]*vec2[1]-vec1[1]*vec2[0];var length=Math.sqrt(dst[0]*dst[0]+dst[1]*dst[1]+dst[2]*dst[2]);if(length!==0){dst[0]/=length;dst[1]/=length;dst[2]/=length;}
return dst;}
function invertMat4(matrix,dstMatrix,returnInverseTranspose){dstMatrix||(dstMatrix=matrix);var det;var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;a=matrix[0];b=matrix[1];c=matrix[2];d=matrix[3];e=matrix[4];f=matrix[5];g=matrix[6];h=matrix[7];i=matrix[8];j=matrix[9];k=matrix[10];l=matrix[11];m=matrix[12];n=matrix[13];o=matrix[14];p=matrix[15];det=a*f*k*p+b*g*l*m+c*h*i*n+d*e*j*o;det-=m*j*g*d+n*k*h*a+o*l*e*b+p*i*f*c;if(det!==0){if(returnInverseTranspose){dstMatrix[0]=(f*k*p+g*l*n+h*j*o-n*k*h-o*l*f-p*j*g)/det;dstMatrix[1]=(e*k*p+g*l*m+h*i*o-m*k*h-o*l*e-p*i*g)/-det;dstMatrix[2]=(e*j*p+f*l*m+h*i*n-m*j*h-n*l*e-p*i*f)/det;dstMatrix[3]=(e*j*o+f*k*m+g*i*n-m*j*g-n*k*e-o*i*f)/-det;dstMatrix[4]=(b*k*p+c*l*n+d*j*o-n*k*d-o*l*b-p*j*c)/-det;dstMatrix[5]=(a*k*p+c*l*m+d*i*o-m*k*d-o*l*a-p*i*c)/det;dstMatrix[6]=(a*j*p+b*l*m+d*i*n-m*j*d-n*l*a-p*i*b)/-det;dstMatrix[7]=(a*j*o+b*k*m+c*i*n-m*j*c-n*k*a-o*i*b)/det;dstMatrix[8]=(b*g*p+c*h*n+d*f*o-n*g*d-o*h*b-p*f*c)/det;dstMatrix[9]=(a*g*p+c*h*m+d*e*o-m*g*d-o*h*a-p*e*c)/-det;dstMatrix[10]=(a*f*p+b*h*m+d*e*n-m*f*d-n*h*a-p*e*b)/det;dstMatrix[11]=(a*f*o+b*g*m+c*e*n-m*f*c-n*g*a-o*e*b)/-det;dstMatrix[12]=(b*g*l+c*h*j+d*f*k-j*g*d-k*h*b-l*f*c)/-det;dstMatrix[13]=(a*g*l+c*h*i+d*e*k-i*g*d-k*h*a-l*e*c)/det;dstMatrix[14]=(a*f*l+b*h*i+d*e*j-i*f*d-j*h*a-l*e*b)/-det;dstMatrix[15]=(a*f*k+b*g*i+c*e*j-i*f*c-j*g*a-k*e*b)/det;}else{dstMatrix[0]=(f*k*p+g*l*n+h*j*o-n*k*h-o*l*f-p*j*g)/det;dstMatrix[4]=(e*k*p+g*l*m+h*i*o-m*k*h-o*l*e-p*i*g)/-det;dstMatrix[8]=(e*j*p+f*l*m+h*i*n-m*j*h-n*l*e-p*i*f)/det;dstMatrix[12]=(e*j*o+f*k*m+g*i*n-m*j*g-n*k*e-o*i*f)/-det;dstMatrix[1]=(b*k*p+c*l*n+d*j*o-n*k*d-o*l*b-p*j*c)/-det;dstMatrix[5]=(a*k*p+c*l*m+d*i*o-m*k*d-o*l*a-p*i*c)/det;dstMatrix[9]=(a*j*p+b*l*m+d*i*n-m*j*d-n*l*a-p*i*b)/-det;dstMatrix[13]=(a*j*o+b*k*m+c*i*n-m*j*c-n*k*a-o*i*b)/det;dstMatrix[2]=(b*g*p+c*h*n+d*f*o-n*g*d-o*h*b-p*f*c)/det;dstMatrix[6]=(a*g*p+c*h*m+d*e*o-m*g*d-o*h*a-p*e*c)/-det;dstMatrix[10]=(a*f*p+b*h*m+d*e*n-m*f*d-n*h*a-p*e*b)/det;dstMatrix[14]=(a*f*o+b*g*m+c*e*n-m*f*c-n*g*a-o*e*b)/-det;dstMatrix[3]=(b*g*l+c*h*j+d*f*k-j*g*d-k*h*b-l*f*c)/-det;dstMatrix[7]=(a*g*l+c*h*i+d*e*k-i*g*d-k*h*a-l*e*c)/det;dstMatrix[11]=(a*f*l+b*h*i+d*e*j-i*f*d-j*h*a-l*e*b)/-det;dstMatrix[15]=(a*f*k+b*g*i+c*e*j-i*f*c-j*g*a-k*e*b)/det;}}
return matrix;}
function loockAtMat4(matrix,x,y,z,atx,aty,atz,upx,upy,upz){vecIn[0]=x-atx;vecIn[1]=y-aty;vecIn[2]=z-atz;vecAt[0]=atx;vecAt[1]=aty;vecAt[2]=atz;vecUp[0]=upx;vecUp[1]=upy;vecUp[2]=upz;normalizedVec3(vecIn,vecZ);crossNormalizedVec3(vecUp,vecZ,vecX);crossNormalizedVec3(vecZ,vecX,vecY);matrix[0]=vecX[0];matrix[1]=vecX[1];matrix[2]=vecX[2];matrix[3]=0;matrix[4]=vecY[0];matrix[5]=vecY[1];matrix[6]=vecY[2];matrix[7]=0;matrix[8]=vecZ[0];matrix[9]=vecZ[1];matrix[10]=vecZ[2];matrix[11]=0;matrix[12]=x;matrix[13]=y;matrix[14]=z;matrix[15]=1;return matrix;}
function perspectiveMat4(matrix,fieldOfView,ratio,znear,zfar){fieldOfView=fieldOfView/180*Math.PI;var fv=1.0/Math.tan(fieldOfView/2);var inversev=1/(znear-zfar);matrix[0]=fv/ratio;matrix[1]=0;matrix[2]=0;matrix[3]=0;matrix[4]=0;matrix[5]=fv;matrix[6]=0;matrix[7]=0;matrix[8]=0;matrix[9]=0;matrix[10]=(zfar+znear)*inversev;matrix[11]=-1;matrix[12]=0;matrix[13]=0;matrix[14]=(zfar*znear*inversev*2);matrix[15]=0;return matrix;}
function ortographicMat4(matrix,ratio,rigth,left,up,down,znear,zfar){matrix[0]=1/(rigth-left)/ratio;matrix[1]=0;matrix[2]=0;matrix[3]=0;matrix[4]=0;matrix[5]=1/(up-down);matrix[6]=0;matrix[7]=0;matrix[8]=0;matrix[9]=0;matrix[10]=1/(znear-zfar);matrix[11]=0;matrix[12]=0;matrix[13]=0;matrix[14]=0;matrix[15]=1;return matrix;}
function multiplyMat4(mat1,mat2,dst){dst[0]=mat1[0]*mat2[0]+mat1[1]*mat2[4]+mat1[2]*mat2[8]+mat1[3]*mat2[12];dst[1]=mat1[0]*mat2[1]+mat1[1]*mat2[5]+mat1[2]*mat2[9]+mat1[3]*mat2[13];dst[2]=mat1[0]*mat2[2]+mat1[1]*mat2[6]+mat1[2]*mat2[10]+mat1[3]*mat2[14];dst[3]=mat1[0]*mat2[3]+mat1[1]*mat2[7]+mat1[2]*mat2[11]+mat1[3]*mat2[15];dst[4]=mat1[4]*mat2[0]+mat1[5]*mat2[4]+mat1[6]*mat2[8]+mat1[7]*mat2[12];dst[5]=mat1[4]*mat2[1]+mat1[5]*mat2[5]+mat1[6]*mat2[9]+mat1[7]*mat2[13];dst[6]=mat1[4]*mat2[2]+mat1[5]*mat2[6]+mat1[6]*mat2[10]+mat1[7]*mat2[14];dst[7]=mat1[4]*mat2[3]+mat1[5]*mat2[7]+mat1[6]*mat2[11]+mat1[7]*mat2[15];dst[8]=mat1[8]*mat2[0]+mat1[9]*mat2[4]+mat1[10]*mat2[8]+mat1[11]*mat2[12];dst[9]=mat1[8]*mat2[1]+mat1[9]*mat2[5]+mat1[10]*mat2[9]+mat1[11]*mat2[13];dst[10]=mat1[8]*mat2[2]+mat1[9]*mat2[6]+mat1[10]*mat2[10]+mat1[11]*mat2[14];dst[11]=mat1[8]*mat2[3]+mat1[9]*mat2[7]+mat1[10]*mat2[11]+mat1[11]*mat2[15];dst[12]=mat1[12]*mat2[0]+mat1[13]*mat2[4]+mat1[14]*mat2[8]+mat1[15]*mat2[12];dst[13]=mat1[12]*mat2[1]+mat1[13]*mat2[5]+mat1[14]*mat2[9]+mat1[15]*mat2[13];dst[14]=mat1[12]*mat2[2]+mat1[13]*mat2[6]+mat1[14]*mat2[10]+mat1[15]*mat2[14];dst[15]=mat1[12]*mat2[3]+mat1[13]*mat2[7]+mat1[14]*mat2[11]+mat1[15]*mat2[15];return dst;}
function translateMat4(matrix,Tx,Ty,Tz){if(Tx)
matrix[12]+=Tx*matrix[0]+Ty*matrix[4]+Tz*matrix[8];if(Ty)
matrix[13]+=Tx*matrix[1]+Ty*matrix[5]+Tz*matrix[9];if(Tz)
matrix[14]+=Tx*matrix[2]+Ty*matrix[6]+Tz*matrix[10];return matrix;}
function rotateMat4(matrix,Rx,Ry,Rz){var x,y,z,s,c;if(Rx){Rx*=Math.PI/180;s=Math.sin(Rx);c=Math.cos(Rx);y=matrix[4];z=matrix[8];matrix[4]=y*c+z*s;matrix[8]=-y*s+z*c;y=matrix[5];z=matrix[9];matrix[5]=y*c+z*s;matrix[9]=-y*s+z*c;y=matrix[6];z=matrix[10];matrix[6]=y*c+z*s;matrix[10]=-y*s+z*c;}
if(Ry){Ry*=Math.PI/180;s=Math.sin(Ry);c=Math.cos(Ry);x=matrix[0];z=matrix[8];matrix[0]=x*c-z*s;matrix[8]=x*s+z*c;x=matrix[1];z=matrix[9];matrix[1]=x*c-z*s;matrix[9]=x*s+z*c;x=matrix[2];z=matrix[10];matrix[2]=x*c-z*s;matrix[10]=x*s+z*c;}
if(Rz){Rz*=Math.PI/180;s=Math.sin(Rz);c=Math.cos(Rz);x=matrix[0];y=matrix[4];matrix[0]=x*c+y*s;matrix[4]=-x*s+y*c;x=matrix[1];y=matrix[5];matrix[1]=x*c+y*s;matrix[5]=-x*s+y*c;x=matrix[2];y=matrix[6];matrix[2]=x*c+y*s;matrix[6]=-x*s+y*c;}
return matrix;}
function scaleMat4(matrix,Sx,Sy,Sz){if(Sx&&Sx!==1){matrix[0]*=Sx;matrix[1]*=Sx;matrix[2]*=Sx;matrix[3]*=Sx;}
if(Sy&&Sy!==1){matrix[4]*=Sy;matrix[5]*=Sy;matrix[6]*=Sy;matrix[7]*=Sy;}
if(Sz&&Sz!==1){matrix[8]*=Sz;matrix[9]*=Sz;matrix[10]*=Sz;matrix[11]*=Sz;}
return matrix;}
function identityMat4(matrix){matrix[0]=1;matrix[1]=0;matrix[2]=0;matrix[3]=0;matrix[4]=0;matrix[5]=1;matrix[6]=0;matrix[7]=0;matrix[8]=0;matrix[9]=0;matrix[10]=1;matrix[11]=0;matrix[12]=0;matrix[13]=0;matrix[14]=0;matrix[15]=1;return matrix;}
function copyMat4(matrixSrc,matrixDst){matrixDst[0]=matrixSrc[0];matrixDst[1]=matrixSrc[1];matrixDst[2]=matrixSrc[2];matrixDst[3]=matrixSrc[3];matrixDst[4]=matrixSrc[4];matrixDst[5]=matrixSrc[5];matrixDst[6]=matrixSrc[6];matrixDst[7]=matrixSrc[7];matrixDst[8]=matrixSrc[8];matrixDst[9]=matrixSrc[9];matrixDst[10]=matrixSrc[10];matrixDst[11]=matrixSrc[11];matrixDst[12]=matrixSrc[12];matrixDst[13]=matrixSrc[13];matrixDst[14]=matrixSrc[14];matrixDst[15]=matrixSrc[15];return matrixDst;}
function createUpdateablePropertyVector(object,property1,property2,property3,value1,value2,value3){var vector=new Float32Array([value1,value2,value3]);vector.self=object;property1&&Object.defineProperty(vector,property1,{configurable:false,get:function(){return this[0];},set:function(newValue){if(newValue!==this[0]){this[0]=newValue;this.self.updated=true;}}});property2&&Object.defineProperty(vector,property2,{configurable:false,get:function(){return this[1];},set:function(newValue){if(newValue!==this[1]){this[1]=newValue;this.self.updated=true;}}});property3&&Object.defineProperty(vector,property3,{configurable:false,get:function(){return this[2];},set:function(newValue){if(newValue!==this[2]){this[2]=newValue;this.self.updated=true;}}});vector.set=function(newValue1,newValue2,newValue3){this[0]=newValue1;this[1]=newValue2;this[2]=newValue3;this.self.updated=true;};vector.get=function(){return new Float32Array(this);};return vector;}
function createPropertyVector(property1,property2,property3,value1,value2,value3){var vector=new Float32Array([value1,value2,value3]);property1&&Object.defineProperty(vector,property1,{configurable:false,get:function(){return this[0];},set:function(v){this[0]=v;}});property2&&Object.defineProperty(vector,property2,{configurable:false,get:function(){return this[1];},set:function(v){this[1]=v;}});property3&&Object.defineProperty(vector,property3,{configurable:false,get:function(){return this[2];},set:function(v){this[2]=v;}});vector.set=function(newValue1,newValue2,newValue3){this[0]=newValue1;this[1]=newValue2;this[2]=newValue3;this.self.updated=true;};vector.get=function(){return new Float32Array(this);};return vector;}
function defineUpdateableProperty(object,propertyName,value){Object.defineProperty(object,propertyName,{configurable:false,get:function(){return value;},set:function(newValue){if(newValue!==value){value=newValue;this.updated=true;}}});}
function defineUneditableProperty(object,propertyName,value){Object.defineProperty(object,propertyName,{whritable:false,value:value});}
M3D.Node=function(data,before,next){this.data=data;this.before=before;this.next=next;};M3D.Node.prototype.set=function(data,before,next){this.data=data;this.before=before;this.next=next;return this;};M3D.List=function(){this.size=0;this.head=null;this.last=null;};M3D.List.prototype.add=function(data){var node;if(this.head===null){this.head=node=new M3D.Node(data,null,null);}else{this.last.next=node=new M3D.Node(data,this.last,null);}
this.last=node;this.size++;return data;};M3D.List.prototype.get=function(data){var response=null;var node=this.head;while(!response&&node){if(node.data===data)
response=node.data;else
node=node.next;}
return response;};M3D.List.prototype.iterate=function(){return new M3Dp.ListIterator(this);};M3D.List.prototype.remove=function(data){var found=false;var response=null;var head=this.head;var node=head;while(!found&&node){if(node.data===data)
found=true;else
node=node.next;}
if(found)
response=this.removeNode(node).data;return response;};M3D.List.prototype.getByName=function(name){var response=null;var node=this.head;while(!response&&node){if(node.data.name===name)
response=node.data;else
node=node.next;}
return response;};M3D.List.prototype.removeByName=function(name){var found=false;var response=null;var head=this.head;var node=head;while(!found&&node){if(node.data.name===name)
found=true;else
node=node.next;}
if(found)
response=this.removeNode(node).data;return response;};M3D.List.prototype.addNode=function(node){if(!node)
return node;node.before=this.head?this.last:null;node.next=null;!this.head&&(this.head=node);this.last&&(this.last.next=node);this.last=node;this.size++;return node;};M3D.List.prototype.removeNode=function(node){if(!node)
return node;var before=node.before;var next=node.next;if(this.head){before&&(before.next=next);next&&(next.before=before);node===this.head&&(this.head=next);node===this.last&&(this.last=next||before);this.size--;}
node.before=null;node.next=null;return node;};M3D.List.prototype.clear=function(){this.head=null;this.size=0;};M3D.List.prototype.isEmpty=function(){return!!this.head;};M3Dp.ListIterator=function(list){this.iterator=list.head;};M3Dp.ListIterator.prototype.next=function(){var node=this.iterator;if(node){this.iterator=node.next;return node.data;}
return null;};M3Dp.ListIterator.prototype.nextNode=function(){var node=this.iterator;if(node)
this.iterator=node.next;return node;};M3D.Stack=function(){this.dataArray=new Array(10);this.size=0;};M3D.Stack.prototype.push=function(data){return this.dataArray[this.size++]=data;};M3D.Stack.prototype.pop=function(){return this.size>0?this.dataArray[--this.size]:null;};M3D.Stack.prototype.clear=function(){this.size=0;};M3D.Stack.prototype.isEmpty=function(){return this.size===0;};M3D.Scene=function(){defineUneditableProperty(this,'ligths',new M3D.List());defineUneditableProperty(this,'models',new M3D.List());defineUneditableProperty(this,'objects',new M3D.List());defineUneditableProperty(this,'sceneNodeName','scene'+elementID++);this.updatedNode=null;};M3D.Scene.prototype.addLigth=function(ligth,name){var node;if(ligth instanceof M3D.Ligth){name&&(ligth.name=name);node=ligth[this.sceneNodeName];if(!node)
ligth[this.sceneNodeName]=this.ligths.addNode(new M3D.Node(ligth));else if(!node.data)
this.ligths.addNode(node).data=ligth;else;}
return ligth;};M3D.Scene.prototype.addModel=function(model,name){var node;if(model instanceof M3D.Model){name&&(model.name=name);node=model[this.sceneNodeName];if(!node)
model[this.sceneNodeName]=this.models.addNode(new M3D.Node(model));else if(!node.data)
this.models.addNode(node).data=model;else;}
return model;};M3D.Scene.prototype.addObject=function(object,name){var node;if(object instanceof M3D.Object){name&&(object.name=name);node=object[this.sceneNodeName];if(!node)
object[this.sceneNodeName]=this.objects.addNode(new M3D.Node(object));else if(!node.data)
this.objects.addNode(node).data=object;else;}
return object;};M3D.Scene.prototype.getLigth=function(name){return this.ligths.getByName(name);};M3D.Scene.prototype.getModel=function(name){return this.models.getByName(name);};M3D.Scene.prototype.getObject=function(name){return this.objects.getByName(name);};M3D.Scene.prototype.removeLigth=function(src){if(typeof src==='string'&&(src=this.ligths.removeByName(src)))
src[this.sceneNodeName].data=null;else if((node=src[this.sceneNodeName]).data!==null)
this.ligths.removeNode(node).data=null;return src;};M3D.Scene.prototype.removeModel=function(src){var node;if(typeof src==='string'&&(src=this.models.removeByName(src)))
src[this.sceneNodeName].data=null;else if((node=src[this.sceneNodeName]).data!==null)
this.models.removeNode(node).data=null;return src;};M3D.Scene.prototype.removeObject=function(src){var node;if(typeof src==='string'){src=this.objects.getByName(src);node=src?src[this.sceneNodeName]:null;}else if(src instanceof M3D.Object){node=src[this.sceneNodeName];}else{;}
if(node&&node.data!==null){if(node===this.updatedNode)
this.updatedNode=node.next;this.objects.removeNode(node);node.data=null;}
return src;};M3D.Scene.prototype.removeAllObjects=function(){var node,next;node=this.objects.head;this.objects.clear();while(node){next=node.next;node.before=null;node.next=null;node.data=null;node=next;}
this.updatedNode=null;};M3D.Scene.prototype.updateObjects=function(){var object;var node=this.objects.head;while(node){object=node.data;node=node.next;this.updatedNode=node;if(object.enable&&!object.parent)
object.update();node=this.updatedNode;}};M3D.Model=new Function();M3D.Model.Instance=new Function();M3D.Model.Material=new Function();M3D.Camera=function(name,projection,x,y,z){defineUneditableProperty(this,'id',elementID++);this.name=name;this.projection=projection||new M3D.Camera.PerspectiveProjection();this.coords=createUpdateablePropertyVector(this,'x','y','z',x||0,y||0,z||0);this.target=createUpdateablePropertyVector(this,'x','y','z',0,0,0);this.upvect=createUpdateablePropertyVector(this,'x','y','z',0,1,0);this.direction=createUpdateablePropertyVector(this,'x','y','z',0,0,-1);this.hasTarget=false;this.viewMatrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.lookMatrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.updated=true;};M3D.Camera.prototype.setCoords=function(x,y,z){this.coords[0]=x;this.coords[1]=y;this.coords[2]=z;this.updated=true;};M3D.Camera.prototype.setDirection=function(x,y,z){var length=Math.sqrt(x*x+y*y+z*z);if(length!==0){this.direction[0]=x/length;this.direction[1]=y/length;this.direction[2]=z/length;}else{this.direction[0]=0;this.direction[1]=0;this.direction[2]=1;}
this.updated=true;};M3D.Camera.prototype.setTargetCoords=function(x,y,z){this.target[0]=x;this.target[1]=y;this.target[2]=z;this.hasTarget=true;this.updated=true;};M3D.Camera.prototype.removeTarget=function(){this.hasTarget=false;this.updated=true;};M3D.Camera.prototype.setProjection=function(projection){if(projection instanceof M3Dp.CameraProjection){projection.ratio=this.projection.ratio;this.projection=projection;}else{throw new Error('Not valid projection provided to Camera '+this.name);}};M3D.Camera.prototype.computeOutputScreenRatio=function(width,height){if(width&&height)
this.projection.ratio=width/height;return this.projection.ratio;};M3D.Camera.prototype.isObjectVisibile=function(object){var visible=false;var vx=object.coords[0]-this.coords[0];var vy=object.coords[1]-this.coords[1];var vz=object.coords[2]-this.coords[2];var length=Math.sqrt(vx*vx+vy*vy+vz*vz);if(length>0&&length<=this.projection.maxDistance)
visible=(this.projection.fieldOfViewDot||0)<=(vx/length*this.direction[0]+vy/length*this.direction[1]+vz/length*this.direction[2]);return visible;};M3D.Camera.prototype.update=function(){var coords=this.coords;var target=this.target;var direction=this.direction;if(this.hasTarget){var vx=target[0]-coords[0];var vy=target[1]-coords[1];var vz=target[2]-coords[2];var length=Math.sqrt(vx*vx+vy*vy+vz*vz);if(length!==0){direction[0]=vx/length;direction[1]=vy/length;direction[2]=vz/length;}else{direction[0]=0;direction[1]=0;direction[2]=1;}}else{target[0]=coords[0]+direction[0];target[1]=coords[1]+direction[1];target[2]=coords[2]+direction[2];}
loockAtMat4(this.lookMatrix,coords[0],coords[1],coords[2],target[0],target[1],target[2],this.upvect[0],this.upvect[1],this.upvect[2]);copyMat4(this.lookMatrix,this.viewMatrix);invertMat4(this.viewMatrix);this.updated=false;};M3D.Camera.prototype.sendToGPU=function(gl,cameraStruct){if(this.updated)
this.update();if(this.projection.updated)
this.projection.update();gl.uniformMatrix4fv(cameraStruct.mview,false,this.viewMatrix);gl.uniformMatrix4fv(cameraStruct.mlook,false,this.lookMatrix);gl.uniformMatrix4fv(cameraStruct.mproject,false,this.projection.projectionMatrix);gl.uniform3fv(cameraStruct.coords,this.coords);};M3Dp.CameraProjection=function(){};M3D.Camera.PerspectiveProjection=function(fieldOfView,ratio,znear,zfar){defineUpdateableProperty(this,'ratio',ratio||1);defineUpdateableProperty(this,'fieldOfView',fieldOfView||45);defineUpdateableProperty(this,'znear',znear||0.01);defineUpdateableProperty(this,'zfar',zfar||100);this.projectionMatrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.fieldOfViewDot=0.7071;this.maxDistance=99.99;this.updated=true;};M3D.Camera.PerspectiveProjection.prototype=Object.create(M3Dp.CameraProjection.prototype);M3D.Camera.PerspectiveProjection.prototype.setRatio=function(ratio){isNaN(ratio)||(this.ratio=ratio);};M3D.Camera.PerspectiveProjection.prototype.setFrustrum=function(fieldOfView,znear,zfar){isNaN(fieldOfView)||(this.fieldOfView=fieldOfView);isNaN(znear)||(this.znear=znear);isNaN(zfar)||(this.zfar=zfar);};M3D.Camera.PerspectiveProjection.prototype.update=function(){this.fieldOfViewDot=Math.cos(this.fieldOfView*Math.PI/180);this.maxDistance=(this.zfar-this.znear)/this.fieldOfViewDot;perspectiveMat4(this.projectionMatrix,this.fieldOfView,this.ratio,this.znear,this.zfar);this.updated=false;};M3D.Camera.OrtographicProjection=function(ratio,rigth,left,up,down,znear,zfar){defineUpdateableProperty(this,'ratio',ratio||1);defineUpdateableProperty(this,'rigth',rigth||1);defineUpdateableProperty(this,'left',left||-1);defineUpdateableProperty(this,'up',up||1);defineUpdateableProperty(this,'down',down||-1);defineUpdateableProperty(this,'znear',znear||1);defineUpdateableProperty(this,'zfar',zfar||-1);this.projectionMatrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.maxDistance=2;this.updated=true;};M3D.Camera.OrtographicProjection.prototype=Object.create(M3Dp.CameraProjection.prototype);M3D.Camera.OrtographicProjection.prototype.setRatio=function(ratio){isNaN(ratio)||(this.ratio=ratio);};M3D.Camera.OrtographicProjection.prototype.setFrustrum=function(rigth,left,up,down,znear,zfar){isNaN(rigth)||(this.rigth=rigth);isNaN(left)||(this.left=left);isNaN(up)||(this.up=up);isNaN(down)||(this.down=down);isNaN(znear)||(this.znear=znear);isNaN(zfar)||(this.zfar=zfar);};M3D.Camera.OrtographicProjection.prototype.setCubicFrustrum=function(width,height,depth){isNaN(width)&&(width=1);isNaN(height)&&(height=width);isNaN(depth)&&(depth=width);this.rigth=width/2;this.left=-width/2;this.up=height/2;this.down=-height/2;this.znear=-depth/2;this.zfar=depth/2;};M3D.Camera.OrtographicProjection.prototype.update=function(){this.maxDistance=this.far-this.near;ortographicMat4(this.projectionMatrix,this.ratio,this.rigth,this.left,this.up,this.down,this.znear,this.zfar);this.updated=false;};M3D.Ligth=function(name,type,x,y,z,r,g,b){this.name=name;defineUneditableProperty(this,'id',elementID++);defineUpdateableProperty(this,'type',type||M3D.Ligth.DOTTED);this.enable=false;this.updated=false;this.coords=createUpdateablePropertyVector(this,'x','y','z',x||0,y||0,z||0);this.target=createUpdateablePropertyVector(this,'x','y','z',0,0,0);this.color=createUpdateablePropertyVector(this,'r','g','b',r||1,g||1,b||1);this.direction=createUpdateablePropertyVector(this,'x','y','z',1,1,1);this.maxDot=-1;this.hasTarget=true;defineUpdateableProperty(this,'spotAngle',360);defineUpdateableProperty(this,'ratio',100);this.updated=true;};defineUneditableProperty(M3D.Ligth,'AMBIENTAL',6267001);defineUneditableProperty(M3D.Ligth,'DIRECTIONAL',667002);defineUneditableProperty(M3D.Ligth,'DOTTED',6267003);defineUneditableProperty(M3D.Ligth,'SPOT',6267004);M3D.Ligth.prototype.setType=function(type){this.type=type;};M3D.Ligth.prototype.setCoords=function(x,y,z){this.coords[0]=x;this.coords[1]=y;this.coords[2]=z;this.updated=true;};M3D.Ligth.prototype.setDirection=function(x,y,z){var length=Math.sqrt(x*x+y*y+z*z);if(length!==0){this.direction[0]=x/length;this.direction[1]=y/length;this.direction[2]=z/length;}else{this.direction[0]=0;this.direction[1]=0;this.direction[2]=1;}
this.updated=true;};M3D.Ligth.prototype.setTargetCoords=function(x,y,z){this.target[0]=x;this.target[1]=y;this.target[2]=z;this.hasTarget=true;this.updated=true;};M3D.Ligth.prototype.removeTarget=function(){this.hasTarget=false;this.updated=true;};M3D.Ligth.prototype.setColor=function(red,green,blue){this.color[0]=red||0;this.color[1]=green||0;this.color[2]=blue||0;this.updated=true;};M3D.Ligth.prototype.setAngle=function(angle){this.spotAngle=angle;};M3D.Ligth.prototype.setEnable=function(enable){this.enable=enable;};M3D.Ligth.prototype.update=function(){var dx,dy,dz,length;if(this.hasTarget){dx=this.coords.x-this.target.x;dy=this.coords.y-this.target.y;dz=this.coords.z-this.target.z;length=Math.sqrt(dx*dx+dy*dy+dz*dz);if(length!==0){this.direction[0]=dx/length;this.direction[1]=dy/length;this.direction[2]=dz/length;}else{this.direction[0]=0;this.direction[1]=0;this.direction[2]=1;}}
this.maxDot=Math.cos(this.spotAngle/180*Math.PI);this.updated=false;};M3D.Ligth.prototype.sendToGPU=function(gl,ligthStruct){if(this.updated)
this.update();gl.uniform1i(ligthStruct.enable,this.enable?1:0);switch(this.type){case M3D.Ligth.AMBIENTAL:gl.uniform1i(ligthStruct.ambient,1);gl.uniform1i(ligthStruct.directional,0);gl.uniform1i(ligthStruct.spot,0);break;case M3D.Ligth.DIRECTIONAL:gl.uniform1i(ligthStruct.ambient,0);gl.uniform1i(ligthStruct.directional,1);gl.uniform1i(ligthStruct.spot,0);break;default:gl.uniform1i(ligthStruct.ambient,0);gl.uniform1i(ligthStruct.directional,0);gl.uniform1i(ligthStruct.spot,1);gl.uniform1f(ligthStruct.ratio,this.ratio);if(this.type===M3D.Ligth.SPOT)
gl.uniform1f(ligthStruct.maxDot,this.maxDot);else
gl.uniform1f(ligthStruct.maxDot,-1);break;}
gl.uniform3fv(ligthStruct.coords,this.coords);gl.uniform3fv(ligthStruct.color,this.color);gl.uniform3fv(ligthStruct.direction,this.direction);};M3D.Object=function(name,model,x,y,z){defineUneditableProperty(this,'id',elementID++);this.name=name;this.type=0;this.enable=true;this.visible=false;this.updated=false;this.geometry=new M3D.Box();this.model=null;this.controller=null;this.coords=createUpdateablePropertyVector(this,'x','y','z',x||0,y||0,z||0);this.rotation=createUpdateablePropertyVector(this,'x','y','z',0,0,0);this.scale=createUpdateablePropertyVector(this,'x','y','z',1,1,1);this.stack=null;this.parent=null;this.childrens=null;this.hasChildrens=false;this.localMatrix=new Float32Array(identityMatrix);this.finalMatrix=new Float32Array(identityMatrix);this.normalMatrix=new Float32Array(identityMatrix);if(model){this.setModel(model);}};M3Dp.Object={};M3D.Object.prototype.setCoords=function(Px,Py,Pz){this.coords[0]=Px;this.coords[1]=Py;this.coords[2]=Pz;this.updated=true;};M3D.Object.prototype.setRotation=function(Rx,Ry,Rz){this.rotation[0]=Rx;this.rotation[1]=Ry;this.rotation[2]=Rz;this.updated=true;};M3D.Object.prototype.setScale=function(Sx,Sy,Sz){isNaN(Sx)&&(Sx=1);this.scale[0]=Sx;this.scale[1]=Sy||Sx;this.scale[2]=Sz||Sx;this.updated=true;};M3D.Object.prototype.setModel=function(model){var modelInstance=null;if(model instanceof M3D.Model){modelInstance=model.makeInstance();modelInstance.transformMatrix=this.finalMatrix;modelInstance.normalMatrix=this.normalMatrix;this.model=modelInstance;}
return this;};M3D.Object.prototype.setGeometry=function(geometry){if(geometry instanceof M3D.Geometry){this.geometry=geometry;this.updated=true;}};M3D.Object.prototype.setController=function(controller){if(controller instanceof M3D.Controller){this.controller=controller.makeController(this);}};M3D.Object.prototype.setVisible=function(visible){this.visible=visible;};M3D.Object.prototype.setEnable=function(enable){this.enable=enable;};M3D.Object.prototype.addChildren=function(childrenObject){if(childrenObject){if(!this.childrens)
this.childrens=new M3D.List();this.childrens.add(childrenObject).parent=this;if(this.childrens.size===1){this.hasChildrens=true;this.herarchyChanged=true;this.update=M3Dp.Object.updateHerarchy;if(!this.stack)
this.stack=new M3D.Stack();}}
return childrenObject;};M3D.Object.prototype.deleteChildren=function(deletedObjectName){var childrenObject;if(this.childrens){childrenObject=this.childrens&&this.childrens.removeByName(deletedObjectName);if(childrenObject){childrenObject.parent=null;if(this.childrens.size===0){this.hasChildrens=false;this.update=M3Dp.Object.updateObject;}}}
return childrenObject;};M3D.Object.prototype.clearChildrens=function(){var children=null;var node;if(this.hasChildrens){node=this.childrens.head;while(node){children=node.data;node=node.next;children.parent=null;}
this.childrens.head=null;}
this.update=M3Dp.Object.updateHerarchy;};M3D.Object.prototype.getChildrens=function(depth){var output=new M3D.Stack();var isRoot=true;var level=0;var parent;var object;var node;var stack;if(this.hasChildrens){stack=this.stack;do{if(node||isRoot){if(node){object=node.data;node=node.next;output.push(object);}else{object=this;isRoot=false;}
if(object.hasChildrens&&level<1){stack.push(parent);stack.push(node);parent=object;node=parent.childrens.head;depth&&level++;}}else{node=stack.pop();parent=stack.pop();}}while(parent);}
return output.dataArray;};M3D.Object.prototype.reset=function(){this.coords[0]=0;this.coords[1]=0;this.coords[2]=0;this.rotation[0]=0;this.rotation[1]=0;this.rotation[2]=0;this.scale[0]=1;this.scale[1]=1;this.scale[2]=1;if(this.controller)
this.controller.reset(this);this.updated=true;};M3D.Object.prototype.draw=function(){if(this.visible)
this.model.sendDrawCall();};M3Dp.Object.updateHerarchy=function(){var stack=this.stack;var isRoot=true;var object=null;var parent=null;var node=null;var updated;var controller;var geometry;var coords;var rotation;var scale;var parentTransformMatrix;var localTransformMatrix;var finalTransformMatrix;var normalTransformMatrix;do{if(node||isRoot){if(node){object=node.data;node=node.next;}else{object=this;isRoot=false;}
localTransformMatrix=object.localMatrix;finalTransformMatrix=object.finalMatrix;normalTransformMatrix=object.normalMatrix;geometry=object.geometry;controller=object.controller;coords=object.coords;rotation=object.rotation;scale=object.scale;updated=object.updated;object.updated=false;if(updated){identityMat4(localTransformMatrix);translateMat4(localTransformMatrix,coords[0],coords[1],coords[2]);rotateMat4(localTransformMatrix,rotation[0],rotation[1],rotation[2]);scaleMat4(localTransformMatrix,scale[0],scale[1],scale[2]);if(!parent){copyMat4(localTransformMatrix,finalTransformMatrix);invertMat4(finalTransformMatrix,normalTransformMatrix,true);}}
if(parent){multiplyMat4(localTransformMatrix,parentTransformMatrix,finalTransformMatrix);invertMat4(finalTransformMatrix,normalTransformMatrix,true);updated=true;}
if(updated)
geometry.update(object);if(controller)
controller.update(object);if(object.hasChildrens){stack.push(parent);stack.push(node);parent=object;node=parent.childrens.head;parentTransformMatrix=parent.finalMatrix;}}else{node=stack.pop();parent=stack.pop();}}while(parent);};M3Dp.Object.updateObject=function(){var finalTransformMatrix=this.finalMatrix;if(this.updated){this.updated=false;identityMat4(finalTransformMatrix);translateMat4(finalTransformMatrix,this.coords[0],this.coords[1],this.coords[2]);rotateMat4(finalTransformMatrix,this.rotation[0],this.rotation[1],this.rotation[2]);scaleMat4(finalTransformMatrix,this.scale[0],this.scale[1],this.scale[2]);invertMat4(finalTransformMatrix,this.normalMatrix,true);this.geometry.update(this);}
if(this.controller)
this.controller.update(this);};M3D.Object.prototype.update=M3Dp.Object.updateObject;M3D.Controller=function(){};M3D.Controller.prototype.makeController=function(object){var controller=new M3D.Controller();this.initialize.call(controller,object);controller.initialize=this.initialize;controller.reset=this.reset;controller.update=this.update;return controller;};M3D.Controller.prototype.initialize=function(){};M3D.Controller.prototype.reset=function(){};M3D.Controller.prototype.update=function(){};M3D.Geometry=function(){};M3D.Box=function(width,height,depth){width||(width=1);height||(height=1);depth||(depth=1);this.coords=createPropertyVector('x','y','z',0,0,0);this.dimensions=createPropertyVector('width','height','depth',2,2,2);this.rigth=1;this.left=-1;this.up=1;this.down=-1;this.znear=1;this.zfar=-1;};M3D.Box.prototype=Object.create(M3D.Geometry.prototype);M3D.Box.prototype.setDimensions=function(width,height,depth){this.dimensions[0]=width;this.dimensions[1]=height;this.dimensions[2]=depth;this.updated=true;};M3D.Box.prototype.hasColition=function(other){var dx,dy,dz,dr,dv;var hasColition;if(other instanceof M3D.Box){if((hasColition=other.coords[0]>=this.coords[0]?other.left<this.rigth:this.left<other.rigth))
if((hasColition=other.coords[1]>=this.coords[1]?other.down<this.up:this.down<other.up))
hasColition=other.coords[2]>=this.coords[2]?other.zfar<this.znear:this.zfar<other.znear;}else if(other instanceof M3D.Sphere){dx=other.coords[0]-this.coords[0];dy=other.coords[1]-this.coords[1];dz=other.coords[2]-this.coords[2];dr=dx;dv=this.dimensions.width;if(dr<dy){dr=dy;dv=this.dimensions.height;}
if(dr<dz){dr=dz;dv=this.dimensions.depth;}
hasColition=dr<=other.ratio+dv/2;}else{hasColition=false;}
return hasColition;};M3D.Box.prototype.update=function(object){var x=this.coords[0]=object.finalMatrix[12];var y=this.coords[1]=object.finalMatrix[13];var z=this.coords[2]=object.finalMatrix[14];var semivalue=this.dimensions[0]/2;this.rigth=x+semivalue;this.left=x-semivalue;semivalue=this.dimensions[1]/2;this.up=y+semivalue;this.down=y-semivalue;semivalue=this.dimensions[2]/2;this.znear=z+semivalue;this.zfar=z-semivalue;};M3D.Sphere=function(ratio){this.coords=new M3D.Vector(0,0,0);this.ratio=ratio;};M3D.Sphere.prototype.hasColition=function(other){var dx,dy,dz,dr,dv;var hasColition;if(other instanceof M3D.Sphere){dx=other.coords[0]-this.coords[0];dy=other.coords[1]-this.coords[1];dz=other.coords[2]-this.coords[2];dr=Math.sqrt(dx*dx+dy*dy+dz*dz);hasColition=dr<=this.ratio+other.ratio;}else if(other instanceof M3D.Box){dx=other.coords[0]-this.coords[0];dy=other.coords[1]-this.coords[1];dz=other.coords[2]-this.coords[2];dr=dx;dv=other.dimensions.width;if(dr<dy){dr=dy;dv=other.dimensions.height;}
if(dr<dz){dr=dz;dv=other.dimensions.depth;}
hasColition=dr<=this.ratio+dv/2;}else{hasColition=false;}
return hasColition;};M3D.Sphere.prototype.update=function(object){this.coords[0]=object.finalMatrix[12];this.coords[1]=object.finalMatrix[13];this.coords[2]=object.finalMatrix[14];};M3D.RenderShaderFactory=function(){};M3D.RenderShaderFactory.requestAsync=false;M3D.RenderShaderFactory.requestUser=null;M3D.RenderShaderFactory.requestPassword=null;M3D.RenderShaderFactory.oncreate=null;M3D.RenderShaderFactory.loadRenderShader=function(renderer,vertexShaderURL,fragmentShaderURL,requestID){var async=this.requestAsync;var user=this.requestUser;var password=this.requestPassword;var vertexSource;var fragmentSource;var renderShader;var onloadfragment=function(){console.timeEnd(timerID);fragmentSource=this.responseText;renderShader=self.createRenderShader(renderer,vertexSource,fragmentSource);if(self.onload){self.onload(renderShader,requestID);}};var onloadvertex=function(){vertexSource=this.responseText;this.open('GET',fragmentShaderURL,async,user,password);this.onload=onloadfragment;this.send(null);};var XHR=new XMLHttpRequest();var self=this;var timerID='LOADING SHADER';console.time(timerID);console.log("Started request");XHR.onload=onloadvertex;XHR.onerror=function(){console.timeEnd(timerID);console.error("ERROR: Loading shader file as URL "+this.responseURL);if(self.onload){self.onload(null,requestID);}
renderShader=null;};XHR.open('GET',vertexShaderURL,async,user,password);XHR.send(null);console.log(renderShader);return renderShader;};M3D.RenderShaderFactory.createRenderShader=function(renderer,vertexCode,fragmentCode){var gl=renderer.gl;var vertexShader,vertexShaderInfoLog;var fragmentShader,fragmentShaderInfoLog;var shaderProgram,shaderProgramInfoLog;var isLinked,hasError;var response=null;if(renderer instanceof M3D.SceneRenderer&&vertexCode&&fragmentCode){vertexShader=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(vertexShader,vertexCode);gl.compileShader(vertexShader);fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(fragmentShader,fragmentCode);gl.compileShader(fragmentShader);vertexShaderInfoLog=gl.getShaderInfoLog(vertexShader);fragmentShaderInfoLog=gl.getShaderInfoLog(fragmentShader);if(vertexShaderInfoLog||fragmentShaderInfoLog){console.log('ERROR Compiling Shaders.\nDETAILS:');if(vertexShaderInfoLog)
console.error('VERTEX SHADER INFO:\n'+vertexShaderInfoLog);if(fragmentShaderInfoLog)
console.error('FRAGMENT SHADER INFO:\n'+fragmentShaderInfoLog);hasError=true;}else{shaderProgram=gl.createProgram();gl.attachShader(shaderProgram,vertexShader);gl.attachShader(shaderProgram,fragmentShader);gl.linkProgram(shaderProgram);isLinked=gl.getProgramParameter(shaderProgram,gl.LINK_STATUS);if(isLinked){defineUneditableProperty(vertexShader,'source',vertexCode);defineUneditableProperty(fragmentShader,'source',fragmentCode);defineUneditableProperty(shaderProgram,'id',elementID++);defineUneditableProperty(shaderProgram,'isRenderShader',true);defineUneditableProperty(shaderProgram,'gl',gl);defineUneditableProperty(shaderProgram,'vertexShader',vertexShader);defineUneditableProperty(shaderProgram,'fragmentShader',fragmentShader);defineUneditableProperty(shaderProgram,'attribs',{});defineUneditableProperty(shaderProgram,'uniforms',{});defineUneditableProperty(shaderProgram,'addAttrib',M3Dp.RenderShader.addAttrib);defineUneditableProperty(shaderProgram,'addUniform',M3Dp.RenderShader.addUniform);defineUneditableProperty(shaderProgram,'addUniformArray',M3Dp.RenderShader.addUniformArray);defineUneditableProperty(shaderProgram,'addUniformStruct',M3Dp.RenderShader.addUniformStruct);defineUneditableProperty(shaderProgram,'addUniformStructArray',M3Dp.RenderShader.addUniformStructArray);defineUneditableProperty(shaderProgram,'disableVertexAttribs',M3Dp.RenderShader.disableVertexAttribs);defineUneditableProperty(shaderProgram,'destroy',M3Dp.RenderShader.destroy);response=shaderProgram;}else{shaderProgramInfoLog=gl.getProgramInfoLog(shaderProgram);console.error('ERROR Linking Program.\nDETAILS: '+shaderProgramInfoLog);gl.deleteProgram(shaderProgram);hasError=true;}}
if(hasError){gl.deleteShader(vertexShader);gl.deleteShader(fragmentShader);}else{response=shaderProgram;}}
return response;};M3D.RenderShaderFactory.destroyRenderShader=function(renderShader){return renderShader.destroy();};M3Dp.RenderShader=function(){};M3Dp.RenderShader.addAttrib=function(name,attribName){this.attribs[name]=this.gl.getAttribLocation(this,attribName);};M3Dp.RenderShader.addUniform=function(name,uniformName){this.uniforms[name]=this.gl.getUniformLocation(this,uniformName);};M3Dp.RenderShader.addUniformArray=function(name,uniformName,length){var gl=this.gl;var array=this.uniforms[name]=new Array(length);for(var i=0;i<length;i++){array[i]=gl.getUniformLocation(this,uniformName+'['+i+']');}};M3Dp.RenderShader.addUniformStruct=function(name,uniformName,fields){var gl=this.gl;var struct=this.uniforms[name]=new Object();var length=fields.length;for(var i=0;i<length;i++){struct[fields[i]]=gl.getUniformLocation(this,uniformName+'.'+fields[i]);}};M3Dp.RenderShader.addUniformStructArray=function(name,uniformName,fields,length){var gl=this.gl;var array=this.uniforms[name]=new Array();var struct;var size=fields.length;for(var i=0;i<length;i++){array[i]=struct=new Object();for(var j=0;j<size;j++){struct[fields[j]]=gl.getUniformLocation(this,uniformName+'['+i+'].'+fields[j]);}}};M3Dp.RenderShader.disableVertexAttribs=function(){for(var attribIndex in this.attribs){this.gl.disableVertexAttribArray(attribIndex);}};M3Dp.RenderShader.destroy=function(){var gl=this.gl;gl.detachShader(this,this.vertexShader);gl.detachShader(this,this.fragmentShader);gl.deleteShader(this.vertexShader);gl.deleteShader(this.fragmentShader);gl.deleteProgram(this);return null;};M3D.OutputFramebuffer=function(renderer,width,height){var gl;if(renderer instanceof M3D.SceneRenderer){gl=renderer.gl;width>0||(width=256);height>0||(height=256);defineUneditableProperty(this,'id',elementID++);defineUneditableProperty(this,'gl',gl);this.width=width;this.height=height;this.framebuffer=gl.createFramebuffer();this.renderbuffer=gl.createRenderbuffer();this.frame=gl.createTexture();this.frame.initialized=true;this.frame.width=this.width;this.frame.height=this.height;gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer);gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderbuffer);gl.bindTexture(gl.TEXTURE_2D,this.frame);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,width,height);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.frame,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.renderbuffer);gl.clearColor(1,0,0,1);gl.viewport(0,0,this.width,this.height);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);}else{throw new Error('Not provided valid SceneRenderer to make OutputFrameBuffer.');}};M3D.OutputFramebuffer.prototype.setSize=function(width,height){var gl=this.gl;if(width>0&&height>0){this.width=width;this.height=height;gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer);gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderbuffer);gl.bindTexture(gl.TEXTURE_2D,this.frame);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,width,height);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.frame,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this.renderbuffer);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);}};M3D.FPSCounter=function(){this.lastSecondTime=-1;this.lastFrameTime=0;this.fps=0;this.frameInterval=0;this.count=0;this.maxFps=0;this.minFps=60;this.maxInterval=0;this.minIntrval=60;this.frameNumberLog=new Array(60);this.frameIntervalsLog=new Array(60);this.frameNumberLogSize=0;this.frameIntervalsLogSize=0;};M3D.FPSCounter.prototype.countFrame=function(){var currentTime=new Date().getTime();var lastSecondTime=this.lastSecondTime;var lastFrameTime=this.lastFrameTime;var secondInterval;var frameInterval;var hasFrame=false;if(lastSecondTime<=0){this.lastSecondTime=currentTime;this.lastFrameTime=currentTime;}else{secondInterval=currentTime-lastSecondTime;frameInterval=currentTime-lastFrameTime;if(secondInterval>=1000){fps=this.count;fps<=this.maxFps||(this.maxFps=fps);fps>=this.minFps||(this.minFps=fps);if(this.frameNumberLogSize>=60){for(var i=0;i<59;i++){this.frameNumberLog[i]=this.frameNumberLog[i+1];}
if(this.frameNumberLogSize%60)
this.frameNumberLog[59]=fps;else
this.frameNumberLog[59]=-fps;}else{this.frameNumberLog[this.frameNumberLogSize]=fps;}
this.frameNumberLogSize++;this.lastSecondTime=currentTime;this.fps=fps;this.count=-1;hasFrame=true;}
frameInterval<=this.maxInterval||(this.maxInterval=frameInterval);frameInterval>=this.minInterval||(this.minInterval=frameInterval);this.frameInterval=frameInterval;if(hasFrame){frameInterval*=-1;}
if(this.frameIntervalsLogSize>=60){for(var i=0;i<59;i++){this.frameIntervalsLog[i]=this.frameIntervalsLog[i+1];}
this.frameIntervalsLog[59]=frameInterval;}else{this.frameIntervalsLog[this.frameIntervalsLogSize]=frameInterval;this.frameIntervalsLogSize++;}
this.lastFrameTime=currentTime;this.count++;}
return hasFrame;};M3D.FPSCounter.prototype.reset=function(){this.lastSecondTime=0;this.lastFrameTime=0;this.fps=0;this.count=0;this.maxFps=0;this.minFps=60;this.maxInterval=0;this.minIntrval=60;this.frameNumberLogSize=0;this.frameIntervalsLogSize=0;};M3D.FPSCounter.prototype.showFPSRatesGraph=function(context2d,x,y){x||(x=0);y||(y=0);var array=this.frameNumberLog;var length=this.frameNumberLogSize;context2d.save();context2d.beginPath();context2d.rect(x,y,80,90);context2d.clip();context2d.fillStyle='blue';context2d.fillRect(x,y,80,90);context2d.font='10px monospace';context2d.fillStyle='yellow';context2d.fillText('('+this.minFps+' - '+this.maxFps+')',x+10,y+10);context2d.fillText(this.fps+' FPS',x+10,y+85);x+=10;y+=75;context2d.strokeStyle='white';context2d.strokeRect(x,y-60,60,60);context2d.fillStyle='white';for(var i=0,value;i<length;i++){value=array[i];if(value<0){value=-value;context2d.fillStyle='red';if(value>=60)
context2d.fillRect(x+i,y-60,1,60);else
context2d.fillRect(x+i,y-value,1,value);context2d.fillStyle='white';}else{if(value>=60)
context2d.fillRect(x+i,y-60,1,60);else
context2d.fillRect(x+i,y-value,1,value);}}
context2d.restore();};M3D.FPSCounter.prototype.showFPSIntervalsGraph=function(context2d,x,y){x||(x=0);y||(y=0);var array=this.frameIntervalsLog;var length=this.frameIntervalsLogSize;context2d.save();context2d.beginPath();context2d.rect(x,y,80,90);context2d.clip();context2d.fillStyle='green';context2d.fillRect(x,y,80,90);context2d.font='10px monospace';context2d.fillStyle='yellow';context2d.fillText('('+this.maxInterval+' - '+this.minInterval+')',x+10,y+10);context2d.fillText(this.frameInterval+' ms',x+10,y+85);x+=10;y+=75;context2d.strokeStyle='white';context2d.strokeRect(x,y-60,60,60);context2d.fillStyle='white';for(var i=0,value;i<length;i++){value=array[i];if(value<0){value=-value;context2d.fillStyle='red';if(value>=60)
context2d.fillRect(x+i,y-60,1,60);else
context2d.fillRect(x+i,y-value,1,value);context2d.fillStyle='white';}else{if(value>=60)
context2d.fillRect(x+i,y-60,1,60);else
context2d.fillRect(x+i,y-value,1,value);}}
context2d.restore();};M3D.SceneRenderer=function(canvas){if(!canvas)
canvas=document.createElement('canvas');var gl=canvas.getContext('webgl2')||canvas.getContext('webgl')||canvas.getContext('experimental-webgl');if(gl){console.log('RENDRERER INITIALIZED: ');gl.viewport(0,0,canvas.width,canvas.height);gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT);}else{throw new Error('Failed obtaining WebGLRenderingContext');}
defineUneditableProperty(this,'canvas',canvas);defineUneditableProperty(this,'gl',gl);defineUneditableProperty(this,'shaders',new M3D.List());defineUneditableProperty(this,'clearColor',{red:0,green:0,blue:0,alpha:1});};M3D.SceneRenderer.prototype.storeRenderShader=function(shader,name){if(shader&&shader.isRenderShader){name&&(shader.name=name);this.shaders.add(shader);}else{throw new Error("Not added provided shader because is not valid render shader");}
return shader;};M3D.SceneRenderer.prototype.getRenderShader=function(name){return this.shaders.getByName(name);};M3D.SceneRenderer.prototype.removeRenderShader=function(name){return this.shaders.removeByName(name);};M3D.SceneRenderer.prototype.destroyRenderShader=function(name){var shader=this.shaders.removeByName(name);if(shader){shader.destroy(this.gl);}
return shader;};M3D.SceneRenderer.prototype.setOutputResolution=function(width,height){width>=0&&(this.canvas.width=width);height>=0&&(this.canvas.height=height);this.gl.viewport(0,0,this.canvas.width,this.canvas.height);};M3D.SceneRenderer.prototype.setClearColor=function(red,green,blue,alpha){var color=this.clearColor;red>=0&&(color.red=red);green>=0&&(color.green=green);blue>=0&&(color.blue=blue);alpha>=0&&(color.alpha=alpha);this.gl.clearColor(color.red,color.green,color.blue,color.alpha);};M3D.SceneRenderer.prototype.clearScreen=function(){this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);};M3D.SceneRenderer.prototype.drawScene=function(scene,camera,renderOptions){var gl=this.gl;var canvas=this.canvas;var clearColor=this.clearColor;var usedModel;var usedShader;var usedShaderUniforms;var newShader;var objects;var models;var ligths;var objectNode;var modelNode;var ligthNode;var ligthIndex;var shader=null;var outputFramebuffer=null;var executeDrawCalls=true;var preserveDrawCalls=false;var depthTestEnable=true;var cullFaceEnable=true;var blendEnable=false;if(renderOptions){if(renderOptions.depthTestEnable!==undefined)
depthTestEnable=renderOptions.depthTestEnable;if(renderOptions.cullFaceEnable!==undefined)
cullFaceEnable=renderOptions.cullFaceEnable;if(renderOptions.belndEnable!==undefined)
blendEnable=renderOptions.belndEnable;if(renderOptions.executeDrawCalls!==undefined)
executeDrawCalls=renderOptions.executeDrawCalls;if(renderOptions.preserveDrawCalls!==undefined)
preserveDrawCalls=renderOptions.preserveDrawCalls;if(renderOptions.outputFramebuffer instanceof M3D.OutputFramebuffer)
outputFramebuffer=renderOptions.outputFramebuffer;if(renderOptions.shader!==undefined)
shader=renderOptions.shader;}
if(gl&&scene instanceof M3D.Scene&&camera instanceof M3D.Camera){objects=scene.objects;models=scene.models;ligths=scene.ligths;objectNode=objects.head;modelNode=models.head;ligthNode=ligths.head;if(outputFramebuffer){gl.bindFramebuffer(gl.FRAMEBUFFER,outputFramebuffer.framebuffer);gl.viewport(0,0,outputFramebuffer.width,outputFramebuffer.height);}
gl.clearColor(clearColor.red,clearColor.green,clearColor.blue,clearColor.alpha);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);if(depthTestEnable)
gl.enable(gl.DEPTH_TEST);else
gl.disable(gl.DEPTH_TEST);if(cullFaceEnable)
gl.enable(gl.CULL_FACE);else
gl.disable(gl.CULL_FACE);if(blendEnable)
gl.enable(gl.BLEND);else
gl.disable(gl.BLEND);if(camera.updated)
camera.update();if(camera.projection.updated)
camera.projection.update();if(executeDrawCalls){while(objectNode){objectNode.data.draw();objectNode=objectNode.next;}}
while(modelNode){usedModel=modelNode.data;if(usedModel.drawCallsNumber>0){newShader=shader||usedModel.shader;if(newShader!==usedShader&&newShader.isRenderShader){if(usedShader){usedShader.disableVertexAttribs(gl);}
usedShader=newShader;usedShaderUniforms=usedShader.uniforms;gl.useProgram(usedShader);if(usedShaderUniforms.camera){camera.sendToGPU(gl,usedShaderUniforms.camera);}
if(usedShaderUniforms.ligths){ligthIndex=0;while(ligthNode){ligthNode.data.sendToGPU(gl,usedShaderUniforms.ligths[ligthIndex]);ligthNode=ligthNode.next;ligthIndex++;}}}
usedModel.prepare(gl,usedShader);usedModel.executeDrawCalls(gl,preserveDrawCalls);usedModel.unprepare(gl,usedShader);}
modelNode=modelNode.next;}
if(outputFramebuffer){gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,canvas.width,canvas.height);}}};M3D.Animator=function(){var animator=this;this.callback=null;this.requestID=0;this.drawFrame=function(){if(animator.callback){animator.requestID=window.requestAnimationFrame(animator.drawFrame);animator.callback();}};};M3D.Animator.prototype.startAnimation=function(requestCallback){this.requestID=window.cancelAnimationFrame(this.requestID);this.callback=requestCallback;this.requestID=window.requestAnimationFrame(this.drawFrame);};M3D.Animator.prototype.stopAnimation=function(){this.requestID=window.cancelAnimationFrame(this.requestID);};M3Dp.SoundContext={};M3D.SoundContext=function(){this.isEnable=false;this.audioContext=null;defineUneditableProperty(this,'isWebkitContext',!!window.webkitAudioContext);defineUneditableProperty(this,'soundTracks',new M3D.List());try{this.audioContext=new AudioContext();this.audioDestination=this.audioContext.destination;this.audioContext.suspend();}catch(error){console.error('Error generating audioContex \n'+error);}};M3D.SoundContext.prototype.addSound=function(soundTrack){if(soundTrack instanceof M3Dp.SoundTrack)
this.soundTracks.add(soundTrack);return soundTrack;};M3D.SoundContext.prototype.getSound=function(name){return this.soundTracks.getByName(name);};M3D.SoundContext.prototype.removeSound=function(src){var soundTrack;if(src instanceof M3D.SoundTrack)
soundTrack=this.soundTracks.remove(src);else if(typeof src==='string')
soundTrack=this.soundTracks.removeByName(src);else
soundTrack=null;return soundTrack;};M3D.SoundContext.prototype.playSound=function(src){var soundTrack;if(src instanceof M3Dp.SoundTrack)
soundTrack=src;else if(typeof src==='string')
soundTrack=this.soundTracks.getByName(src);else
soundTrack=null;if(soundTrack){soundTrack.play();if(this.audioContext.state==='suspended')
this.audioContext.resume();}};M3D.SoundContext.prototype.pauseSound=function(src){var soundTrack;if(src instanceof M3Dp.SoundTrack)
soundTrack=src;else if(typeof src==='string')
soundTrack=this.soundTracks.getByName(src);else
soundTrack=null;if(soundTrack)
soundTrack.pause();};M3D.SoundContext.prototype.generateSoundTrack=function(name,url,volume,hasLoop){var context=this.audioContext;var gainNode=context.createGain();var soundTrack=new M3Dp.SoundTrack(name);soundTrack.src=url;soundTrack.audioContext=context;soundTrack.gainNode=gainNode;soundTrack.setVolume(volume);soundTrack.hasLoop=!!hasLoop;M3Dp.getSoundBufferData(context,soundTrack);return soundTrack;};M3D.SoundContext.prototype.generateSoundPool=function(name,url,volume){var context=this.audioContext;var gainNode=context.createGain();var soundPool=new M3Dp.SoundPool(name);soundPool.src=url;soundPool.audioContext=context;soundPool.gainNode=gainNode;soundPool.setVolume(volume);M3Dp.getSoundBufferData(context,soundPool);return soundPool;};M3Dp.getSoundBufferData=function(context,soundTrack){var xhr=new XMLHttpRequest();xhr.open('GET',soundTrack.src,true);xhr.onload=function(){var stream=this.response;context.decodeAudioData(stream,function(decodedDataBuffer){console.log('Decoded media source data at URL: '+soundTrack.src);soundTrack.sourceBuffer=decodedDataBuffer;soundTrack.gainNode.connect(context.destination);if(soundTrack.playing)
soundTrack.play();},function(err){console.log('Error decoding source audio at URL: '+soundTrack.src+'\n'+err);});};xhr.onerror=function(err){console.error('Error loading media source data at URL: '+soundTrack.src+'\n'+err);};xhr.responseType='arraybuffer';xhr.send(null);};M3Dp.SoundTrack=function(name){this.name=name;this.src=null;this.audioContext=null;this.sourceBuffer=null;this.gainNode=null;this.time=0;this.offset=0;this.playing=false;this.hasLoop=false;};M3Dp.SoundTrack.prototype.setVolume=function(volume){var gain=this.gainNode.gain;gain.value=volume/100;};M3Dp.SoundTrack.prototype.play=function(){var self=this;this.playing=true;if(!this.mediaNode&&!!this.sourceBuffer){this.time=this.audioContext.currentTime;this.mediaNode=this.audioContext.createBufferSource();this.mediaNode.buffer=this.sourceBuffer;this.mediaNode.onended=function(event){var mediaNode=event.target;mediaNode.disconnect();if(self.mediaNode===mediaNode){self.mediaNode=null;self.offset=0;if(self.hasLoop)
self.play();else
self.playing=false;}};this.mediaNode.connect(this.gainNode);this.mediaNode.start(this.time,this.offset);}};M3Dp.SoundTrack.prototype.pause=function(){var time=this.audioContext.currentTime;this.playing=false;if(!!this.mediaNode){this.offset+=time-this.time;this.time=time;this.mediaNode.stop();this.mediaNode=null;}};M3Dp.SoundPool=function(name){this.name=name;this.src=null;this.audioContext=null;this.sourceBuffer=null;this.gainNode=null;this.instances=new M3D.List();};M3Dp.SoundPool.prototype=Object.create(M3Dp.SoundTrack.prototype);M3Dp.SoundPool.prototype.setVolume=function(volume){var gain=this.gainNode.gain;gain.value=volume/100;};M3Dp.SoundPool.prototype.play=function(){var mediaInstanceNode;var instances=this.instances;if(this.sourceBuffer){mediaInstanceNode=this.audioContext.createBufferSource();mediaInstanceNode.buffer=this.sourceBuffer;mediaInstanceNode.listNode=new M3D.Node(mediaInstanceNode);mediaInstanceNode.onended=function(event){var mediaNode=event.target;mediaNode.disconnect();instances.removeNode(mediaNode.listNode);};mediaInstanceNode.connect(this.gainNode);mediaInstanceNode.start(0);instances.addNode(mediaInstanceNode.listNode);}};M3Dp.SoundPool.prototype.pause=function(){var listNode=this.instances.head;while(listNode){listNode.data.stop();listNode=listNode.next;}};window.AudioContext=window.AudioContext||window.webkitAudioContext;window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.opRequestAnimationFrame||function(callback){return window.setTimeout(callback,40);};window.cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.opCancelAnimationFrame||window.clearTimeout;})();